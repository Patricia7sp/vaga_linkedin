# üåø ESTRAT√âGIA DE BRANCHES - DevOps Best Practices

**Data:** 08/10/2025  
**Status:** ‚úÖ Estrat√©gia definida e implementada

---

## üìä **ESTRUTURA DE BRANCHES RECOMENDADA**

### **Op√ß√£o 1: Modelo Atual (Simplificado) ‚≠ê RECOMENDADO**

```
main (protected)
  ‚îî‚îÄ CI/CD autom√°tico
  ‚îî‚îÄ Deploy para Staging
  ‚îî‚îÄ Testes completos
  ‚îî‚îÄ Aprova√ß√£o manual ‚Üí Produ√ß√£o
```

**Vantagens:**
- ‚úÖ Simplicidade
- ‚úÖ Menos overhead
- ‚úÖ Ideal para times pequenos
- ‚úÖ Pipeline √∫nico e robusto

---

### **Op√ß√£o 2: Modelo GitFlow (Completo)**

```
main (produ√ß√£o) ‚Üê Tag releases
  ‚Üë
  ‚îÇ (merge ap√≥s aprova√ß√£o)
  ‚îÇ
develop (staging) ‚Üê Branch principal de desenvolvimento
  ‚Üë
  ‚îÇ (merge ap√≥s code review)
  ‚îÇ
feature/* ‚Üê Branches tempor√°rias para features
hotfix/*  ‚Üê Corre√ß√µes urgentes
release/* ‚Üê Prepara√ß√£o de releases
```

**Vantagens:**
- ‚úÖ Separa√ß√£o clara entre dev e prod
- ‚úÖ Facilita releases planejadas
- ‚úÖ Ideal para times grandes
- ‚úÖ Rollback mais f√°cil

**Desvantagens:**
- ‚ùå Mais complexo
- ‚ùå Requer disciplina
- ‚ùå Pipeline duplicado (dev + prod)

---

## üéØ **RECOMENDA√á√ÉO PARA SEU PROJETO**

### **Modelo H√≠brido - Main + Feature Branches**

```mermaid
graph LR
    A[feature/nova-funcao] -->|PR + Review| B[main]
    B -->|CI/CD Auto| C[Staging]
    C -->|Smoke Tests| D{Aprovado?}
    D -->|SIM| E[Production]
    D -->|N√ÉO| F[Fix]
    F --> A
```

**Como funciona:**

1. **Desenvolvimento de Features:**
   ```bash
   # Criar branch de feature
   git checkout -b feature/nova-extracao
   
   # Desenvolver e testar localmente
   git add .
   git commit -m "feat: nova extra√ß√£o via API X"
   
   # Push da feature
   git push origin feature/nova-extracao
   ```

2. **Pull Request (PR):**
   - Abrir PR de `feature/nova-extracao` ‚Üí `main`
   - Code review autom√°tico (linters, tests)
   - Aprova√ß√£o manual (voc√™ ou time)

3. **Merge para Main:**
   ```bash
   # Ap√≥s aprova√ß√£o, merge no GitHub
   # OU via CLI:
   gh pr merge --squash
   ```

4. **CI/CD Autom√°tico:**
   ```
   ‚úÖ Code Quality (2min)
   ‚úÖ Tests (4min)
   ‚úÖ Docker Build (30s)
   ‚úÖ Deploy Staging (8min) ‚Üê AUTOM√ÅTICO
   ‚úÖ Smoke Tests (1min)
   ‚úÖ Valida√ß√£o Deploy (30s)
   ```

5. **Deploy Produ√ß√£o (Manual):**
   ```bash
   # Via GitHub Actions
   gh workflow run ci-cd-pipeline.yml -f environment=production
   
   # OU via web:
   # Actions ‚Üí CI/CD Pipeline ‚Üí Run workflow ‚Üí production
   ```

---

## üîß **IMPLEMENTA√á√ÉO DA ESTRAT√âGIA**

### **Passo 1: Proteger Branch Main**

```bash
# Via GitHub CLI
gh api repos/Patricia7sp/vaga_linkedin/branches/main/protection \
  -X PUT \
  -f required_status_checks='{"strict":true,"contexts":["ci"]}' \
  -f enforce_admins=false \
  -f required_pull_request_reviews='{"required_approving_review_count":1}' \
  -f restrictions=null
```

**OU via Web:**
1. Settings ‚Üí Branches ‚Üí Add rule
2. Branch name pattern: `main`
3. ‚òëÔ∏è Require pull request reviews before merging
4. ‚òëÔ∏è Require status checks to pass before merging
5. ‚òëÔ∏è Require branches to be up to date

---

### **Passo 2: Workflow de Feature Branches**

```yaml
# .github/workflows/feature-validation.yml
name: "üîç Feature Branch Validation"

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    name: ‚úÖ Validar Feature
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Code Quality
        run: |
          pip install black flake8
          black --check .
          flake8 .
      
      - name: Unit Tests
        run: pytest tests/unit/ -v
      
      - name: Integration Tests
        run: pytest tests/integration/ -v
```

---

### **Passo 3: Branch Protection com Auto-Merge**

```yaml
# .github/workflows/auto-merge.yml
name: "ü§ñ Auto-Merge PR"

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-merge:
    if: github.actor == 'Patricia7sp'
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## üéØ **WORKFLOW RECOMENDADO PARA VOC√ä**

### **Cen√°rio 1: Feature Nova**

```bash
# 1. Criar branch
git checkout -b feature/melhorar-raspagem

# 2. Desenvolver
# ... c√≥digo ...

# 3. Commit local
git add .
git commit -m "feat: melhora raspagem com retry"

# 4. Push
git push origin feature/melhorar-raspagem

# 5. Abrir PR no GitHub
gh pr create --title "feat: Melhora raspagem com retry" --body "Adiciona retry autom√°tico..."

# 6. Aguardar CI/CD
# GitHub Actions vai rodar automaticamente:
# - Code quality ‚úÖ
# - Tests ‚úÖ
# - Build ‚úÖ

# 7. Merge (se tudo passar)
gh pr merge --squash

# 8. Deploy autom√°tico para Staging
# Pipeline roda automaticamente ap√≥s merge

# 9. Validar em Staging
gcloud run jobs execute vaga-linkedin-prod-staging

# 10. Promover para Produ√ß√£o (manual)
gh workflow run ci-cd-pipeline.yml -f environment=production
```

---

### **Cen√°rio 2: Hotfix Urgente**

```bash
# 1. Criar branch de hotfix
git checkout -b hotfix/corrigir-erro-critico

# 2. Corrigir
# ... c√≥digo ...

# 3. Commit
git add .
git commit -m "fix: corrige erro cr√≠tico na extra√ß√£o"

# 4. Push
git push origin hotfix/corrigir-erro-critico

# 5. PR urgente
gh pr create --title "üö® HOTFIX: Erro cr√≠tico" --body "Corre√ß√£o urgente..."

# 6. Merge r√°pido (ap√≥s review)
gh pr merge --squash

# 7. Deploy autom√°tico Staging
# (autom√°tico)

# 8. Promover para Produ√ß√£o imediatamente
gh workflow run ci-cd-pipeline.yml -f environment=production
```

---

## üìä **COMPARA√á√ÉO: SUA SITUA√á√ÉO vs DevOps Ideal**

| Aspecto | Situa√ß√£o Atual | Ideal DevOps |
|---------|----------------|--------------|
| **Branch Strategy** | Main only | Main + Feature branches |
| **Deploy Staging** | ‚úÖ Autom√°tico | ‚úÖ Autom√°tico |
| **Deploy Prod** | ‚ö†Ô∏è Manual | ‚úÖ Autom√°tico ap√≥s aprova√ß√£o |
| **Code Review** | ‚ùå N√£o | ‚úÖ Obrigat√≥rio via PR |
| **Rollback** | ‚ö†Ô∏è Manual | ‚úÖ Autom√°tico (tag anterior) |
| **Teste em Prod** | ‚úÖ Smoke tests | ‚úÖ Smoke + Canary |
| **Monitoramento** | ‚úÖ Alertas | ‚úÖ Alertas + Auto-healing |

---

## üöÄ **PR√ìXIMOS PASSOS (IMPLEMENTA√á√ÉO)**

### **Fase 1: Prote√ß√£o B√°sica (AGORA)**

```bash
# 1. Proteger branch main
gh api repos/Patricia7sp/vaga_linkedin/branches/main/protection \
  -X PUT \
  -f required_status_checks='{"strict":true,"contexts":["ci"]}' \
  -f required_pull_request_reviews='{"required_approving_review_count":0}'
```

**Resultado:**
- ‚úÖ Commits diretos bloqueados
- ‚úÖ PR obrigat√≥rio
- ‚úÖ CI/CD deve passar

---

### **Fase 2: Feature Branches (SEMANA 1)**

```bash
# Criar primeira feature branch
git checkout -b feature/teste-estrategia
echo "# Teste" >> README.md
git add .
git commit -m "feat: teste estrat√©gia branches"
git push origin feature/teste-estrategia

# Abrir PR
gh pr create --title "feat: Teste estrat√©gia" --body "Testando workflow"

# Aguardar CI/CD passar
# Merge via web ou CLI
gh pr merge --squash
```

---

### **Fase 3: Auto-Deploy Prod (SEMANA 2)**

```yaml
# Adicionar ao .github/workflows/ci-cd-pipeline.yml

  auto-promote-to-prod:
    name: üöÄ Auto-Promote to Production
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main' && success()
    runs-on: ubuntu-latest
    steps:
      - name: Wait for manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: Patricia7sp
          minimum-approvals: 1
          issue-title: "Deploy to Production?"
          issue-body: "Aprovar deploy para produ√ß√£o?"
      
      - name: Deploy to Production
        # ... resto do deploy prod
```

---

## üéØ **RESPOSTA √Ä SUA D√öVIDA**

### **"N√£o seria importante ter branch de desenvolvimento?"**

**Resposta:** Sim e n√£o. Depende do cen√°rio:

#### **‚úÖ SIM, se:**
- Time com 3+ desenvolvedores
- M√∫ltiplas features em paralelo
- Releases planejadas (mensal, trimestral)
- Precisa testar integra√ß√£o de features antes de prod

#### **‚ùå N√ÉO, se:**
- Time pequeno (1-2 pessoas) ‚Üê SEU CASO
- Features pequenas e frequentes
- Deploy cont√≠nuo preferido
- Pipeline robusto com testes completos ‚Üê J√Å TEM

---

### **SUA ESTRAT√âGIA IDEAL:**

```
main (protected)
  ‚Üë
  ‚îÇ (PR obrigat√≥rio)
  ‚îÇ
feature/* ‚Üê Desenvolvimento isolado
hotfix/*  ‚Üê Corre√ß√µes urgentes
```

**Por qu√™?**
1. ‚úÖ `main` sempre est√°vel (s√≥ c√≥digo testado)
2. ‚úÖ Features isoladas (n√£o quebra o que funciona)
3. ‚úÖ CI/CD roda EM TUDO (PR + main)
4. ‚úÖ Staging autom√°tico ap√≥s merge
5. ‚úÖ Produ√ß√£o manual (seguran√ßa extra)
6. ‚úÖ Simples de gerenciar

---

## üìù **COMANDOS √öTEIS**

```bash
# Criar feature branch
git checkout -b feature/nome-da-feature

# Push e criar PR
git push -u origin feature/nome-da-feature
gh pr create

# Ver status do PR
gh pr status

# Merge PR
gh pr merge --squash

# Deletar branch local ap√≥s merge
git branch -d feature/nome-da-feature

# Sincronizar com main
git checkout main
git pull origin main

# Ver pipelines rodando
gh run list

# Ver logs de um pipeline
gh run view <RUN_ID> --log
```

---

## ‚úÖ **CHECKLIST DE IMPLEMENTA√á√ÉO**

### **Fase 1: Prote√ß√£o (5 min)**
- [ ] Proteger branch `main`
- [ ] Configurar PR obrigat√≥rio
- [ ] Configurar CI/CD como required check

### **Fase 2: Workflow (1 dia)**
- [ ] Criar primeira feature branch
- [ ] Testar PR workflow
- [ ] Validar merge e deploy autom√°tico

### **Fase 3: Documenta√ß√£o (30 min)**
- [ ] Documentar processo para o time
- [ ] Criar templates de PR
- [ ] Definir naming conventions

### **Fase 4: Automa√ß√£o Avan√ßada (opcional)**
- [ ] Auto-merge para PRs do owner
- [ ] Canary deploys
- [ ] Blue-green deployment

---

**CONCLUS√ÉO:** Sua abordagem atual est√° CORRETA para o tamanho do projeto! 

**Melhoria sugerida:** Adicionar feature branches + PR obrigat√≥rio = **Perfeito! üéØ**

---

**√öltima atualiza√ß√£o:** 08/10/2025 13:35 BRT  
**Status:** Documenta√ß√£o completa + Pr√≥ximos passos definidos
